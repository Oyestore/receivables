# Phase 1.2: Advanced Invoice Template Management - Design Document

## 1. Introduction

This document outlines the design and implementation plan for Phase 1.2 of the Smart Invoice Generation Agent module: Advanced Invoice Template Management. This phase builds upon the core functionalities established in Phase 1.1 and aims to provide users with flexible and customizable invoice templates, enhancing the professionalism and adaptability of the invoices generated by the SME Receivables Management Platform.

This design adheres to the requirements specified in `invoice_generation_agent_specs.md` (Section 1.2) and the principles outlined in the `General UI_UX Guidelines for Visual Aids, Guided Workflows, and Overall User Experience.md` document. It also considers the need for modularity and incorporates insights from research into Indian industry-specific invoice requirements to ensure the system is valuable and adaptable for Indian businesses.

## 2. Goals for Phase 1.2

*   Provide a robust system for storing and managing invoice templates.
*   Offer a set of professionally designed default templates suitable for various Indian business needs.
*   Enable users to customize templates to match their branding and specific information requirements.
*   Allow for easy assignment of templates at organizational and individual invoice levels.
*   Ensure high-quality, accurate PDF generation from these templates.
*   Maintain a modular architecture for the template management subsystem.

## 3. System Architecture

The Advanced Invoice Template Management system will be a distinct submodule within the Invoice Generation Agent. It will interact with the core invoice data and the PDF generation service.

### 3.1. Components:

1.  **Template Storage:**
    *   **Mechanism:** Templates will be stored in the PostgreSQL database.
    *   **Structure:** Each template will have a definition stored likely as JSON or a structured text format (e.g., a domain-specific language for templates if a visual editor is complex for the initial phase). This definition will describe the layout, styling, and data mapping.
    *   **Attributes:** Template ID, Tenant ID, Organization ID, Template Name, Description, Template Definition (JSON/DSL), IsDefault (boolean), IsSystemTemplate (boolean, for pre-defined ones), Preview Image (URL/path), Created At, Updated At.

2.  **Template Rendering Engine:**
    *   **Technology:** This will be a backend service, likely part of the NestJS Invoice Agent.
    *   **Functionality:** It will take invoice data (from Phase 1.1) and a template definition as input.
    *   It will dynamically populate the template with the invoice data.
    *   It will then utilize a PDF generation library (e.g., WeasyPrint, as it supports HTML/CSS and CJK, or FPDF2 if simplicity is prioritized and HTML/CSS is not strictly needed for the chosen template definition format) to convert the populated template into a PDF document.
    *   The choice of PDF library will depend on the complexity of the template definition format. If templates are defined via HTML/CSS, WeasyPrint is suitable. If a simpler, structured format is used, FPDF2 might be more direct.

3.  **Template Management API Endpoints (NestJS):
    *   `POST /api/templates`: Create a new custom template.
    *   `GET /api/templates`: List available templates for the organization (default and custom), with filtering options.
    *   `GET /api/templates/{templateId}`: Get details of a specific template.
    *   `PUT /api/templates/{templateId}`: Update an existing custom template.
    *   `DELETE /api/templates/{templateId}`: Delete a custom template.
    *   `POST /api/templates/{templateId}/setdefault`: Set a template as the default for the organization.
    *   `GET /api/templates/{templateId}/preview`: Generate a preview of the template (perhaps with sample data).

4.  **User Interface (Frontend - to be developed by a separate UI team, but backend will support these features):
    *   **Template Listing:** Display available system and custom templates with previews.
    *   **Template Editor/Customizer:**
        *   **Approach:** Given the complexity of a full visual drag-and-drop editor, Phase 1.2 might initially focus on a configuration-based customization UI. Users would select a base template and then modify properties through forms and dropdowns.
        *   A more advanced visual editor could be a future enhancement (Phase 1.2+ or later phase).
        *   **Customization Options (as per specs):** Logo placement/size, color schemes, fonts, show/hide fields, header/footer content, line item column adjustments, adding predefined custom fields/labels.
    *   **Template Assignment:** UI to set organizational default and select a template during invoice creation.

### 3.2. Modularity:

*   The template management system (storage, services, controllers) will be a separate NestJS module (`TemplateModule`).
*   The PDF generation logic, if complex, could also be a distinct service, potentially even a microservice if rendering becomes resource-intensive, though initially, it can be part of the Invoice Agent.

## 4. Default Templates

*   A minimum of 3-5 professionally designed default templates will be provided.
*   These will cater to common Indian business scenarios:
    *   **Standard GST Invoice:** A comprehensive template covering all mandatory GST fields.
    *   **Service-Oriented Invoice:** Tailored for service providers, potentially with more space for service descriptions.
    *   **Product-Oriented Invoice:** With clear columns for product details, quantity, units, etc.
    *   **Simple/Minimalist Invoice:** For businesses preferring a cleaner look.
*   These templates will be GST compliant and designed with clarity and professionalism in mind, following UI/UX guidelines.
*   Consideration for common industry needs (e.g., additional fields for transporters, specific disclaimers for certain services) will be incorporated by ensuring the template structure can accommodate optional sections or fields that users can enable.

## 5. Template Customization

As outlined in the `invoice_generation_agent_specs.md` and adhering to `General UI_UX Guidelines`:

### 5.1. UI for Template Management (Backend Support):

*   APIs will support listing templates with metadata for previews.
*   APIs will support setting a default template at the organization level.
*   APIs will support creating new templates (initially by duplicating and modifying a system template or a blank configurable structure) and customizing existing user-created templates.

### 5.2. Customization Options (Configuration-based for initial implementation):

The backend will store and manage configurations for:

*   **Logo:** URL/path to logo image, position (e.g., top-left, top-center, top-right), size constraints.
*   **Color Schemes:** Primary color, secondary color, accent color (for headings, lines, etc.).
*   **Fonts:** Selection from a predefined list of web-safe and Indian language-supporting fonts (e.g., Noto Sans Devanagari, Noto Sans for English content).
*   **Field Visibility:** Toggles to show/hide optional invoice fields (e.g., PO Number, Shipping Address, Discount column, Cess column if not applicable).
*   **Header/Footer Customization:** Text areas for custom header (e.g., business tagline) and footer content (e.g., bank details, detailed terms & conditions, authorized signatory name/designation).
*   **Line Item Columns:** Options to reorder or adjust the relative widths of standard line item columns (Description, HSN/SAC, Qty, Unit Price, Discount, Taxable Value, Tax Rate, Tax Amount, Total).
*   **Custom Fields/Labels:** Allow users to define a limited number (e.g., 2-3) of custom label-value pairs to be displayed in a designated section of the invoice.
*   **Multi-page Support:** The rendering engine must handle invoices that span multiple pages gracefully, repeating essential headers/footers and ensuring proper page numbering.

## 6. Template Assignment

*   **Organizational Default:** The `OrganizationSettings` entity (or a new `TemplateSettings` entity linked to Organization) will store the ID of the default template for an organization.
*   **Invoice-Specific Override:** The `Invoice` entity (from Phase 1.1) will have an optional `templateId` field. If null, the organizational default is used. If specified, that template is used for that specific invoice.
*   APIs for invoice creation/update will accept this optional `templateId`.

## 7. PDF Generation

*   The rendering engine will use the selected template definition and invoice data to generate an HTML representation internally (if using WeasyPrint) or directly construct the PDF (if using FPDF2).
*   **Accuracy:** All calculations (totals, taxes) must be accurately reflected from the invoice data.
*   **Professional Look:** Adherence to selected fonts, colors, logo placement. Clear layout and readability.
*   **Compliance:** Ensure all mandatory GST fields are present if the template is marked as GST-compliant.
*   **Performance:** PDF generation should be reasonably fast. For very complex templates or large invoices, asynchronous generation might be considered in future iterations.
*   **Font Embedding:** Ensure necessary fonts (especially for Indian languages) are embedded in the PDF for correct rendering across devices.

## 8. Data Models (Illustrative - to be refined)

```sql
-- (Extending schema from Phase 1.1)

CREATE TABLE invoice_templates (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id),
    organization_id UUID NOT NULL REFERENCES organizations(id),
    template_name VARCHAR(255) NOT NULL,
    description TEXT,
    template_definition JSONB NOT NULL, -- Stores layout, styles, field mappings
    is_system_template BOOLEAN DEFAULT FALSE,
    is_default_for_org BOOLEAN DEFAULT FALSE, -- Can be managed via a separate setting or a flag here
    preview_image_url VARCHAR(1024),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    CONSTRAINT uq_org_template_name UNIQUE (organization_id, template_name)
);

-- Add to organizations table (or a new settings table):
-- ALTER TABLE organizations ADD COLUMN default_invoice_template_id UUID REFERENCES invoice_templates(id);

-- Add to invoices table (from Phase 1.1):
-- ALTER TABLE invoices ADD COLUMN selected_template_id UUID REFERENCES invoice_templates(id);
```

## 9. UI/UX Considerations (Highlights for Backend Support)

*   **Guided Workflow for Customization:** Even with a configuration-based editor, the UI should guide users step-by-step through customization options (e.g., sections for Header, Footer, Line Items, Colors & Fonts).
*   **Real-time Preview (Ideal):** As users change configurations, a live or quickly refreshable preview of the invoice with sample data would be highly beneficial. The backend should provide an API to generate such previews.
*   **Clarity and Simplicity:** Template options should be clearly labeled and explained with tooltips or help text.
*   **Accessibility:** Ensure generated PDFs are as accessible as possible (e.g., proper tagging if the PDF library supports it, though this is advanced for PDF generation).

## 10. Research on Indian Invoice Formats - Integration

*   **Flexibility:** The `template_definition` (JSONB) should be flexible enough to accommodate common variations:
    *   Optional blocks for transport details (LR No., Vehicle No., Date of Dispatch).
    *   Specific declaration texts required by certain industries.
    *   Fields for batch numbers, expiry dates for goods.
    *   Detailed service breakdowns (if not covered by standard line items).
*   **Default Templates:** One or two of the default templates could be designed with these common additional sections, which users can then toggle on/off.
*   **Custom Fields:** The limited custom fields feature will allow users to add very specific information not covered by standard options.
*   **Bill of Supply:** The system should allow for templates that do not display tax columns (CGST, SGST, IGST) for scenarios like a Bill of Supply. This can be a property of the template or a setting during invoice creation that influences field visibility.
*   **Debit/Credit Notes:** While Phase 1.2 focuses on invoice templates, the design should be mindful that similar templating might be needed for debit/credit notes in the future. The core rendering engine could be reusable.

## 11. Implementation Plan (High-Level)

1.  **Database Schema:** Finalize and implement database changes for `invoice_templates` and related tables.
2.  **NestJS Module (`TemplateModule`):**
    *   Create entities for `InvoiceTemplate`.
    *   Develop DTOs for template creation and update.
    *   Implement `TemplateService` for CRUD operations, setting default, and managing template configurations.
    *   Implement `TemplateController` for API endpoints.
3.  **Rendering Engine & PDF Generation Service:**
    *   Select and integrate a PDF generation library.
    *   Develop the service to take invoice data and template definition, and output a PDF stream.
4.  **Default Templates:** Design and implement the initial set of default template definitions.
5.  **Integration:** Integrate the template selection logic into the invoice creation/viewing process (from Phase 1.1).
6.  **Testing:** Thorough unit and integration testing.

## 12. Future Considerations (Post Phase 1.2)

*   Full visual drag-and-drop template editor.
*   More advanced logic for conditional display of sections/fields within templates.
*   User-defined data sources for populating templates beyond standard invoice fields.
*   Template versioning.

This design document provides a roadmap for developing the Advanced Invoice Template Management features. It will be refined further as development progresses and based on user feedback.

