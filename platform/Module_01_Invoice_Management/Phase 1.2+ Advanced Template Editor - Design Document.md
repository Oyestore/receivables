# Phase 1.2+ Advanced Template Editor - Design Document

## 1. Introduction

This document outlines the proposed design for the advanced invoice template editor, incorporating a visual drag-and-drop interface and advanced features as requested. This builds upon the existing template management system and aims to provide a significantly more flexible and user-friendly experience for customizing invoice templates.

The key new features for this "Phase 1.2+" are:
1.  A full visual drag-and-drop template editor.
2.  Advanced logic for conditional display of sections/fields within templates.
3.  User-defined data sources for populating templates beyond standard invoice fields.
4.  Template versioning.

## 2. Proposed Technology: GrapesJS

Based on initial research, GrapesJS (https://grapesjs.com/) appears to be a suitable open-source framework for building the visual template editor. It offers:

*   A core drag-and-drop interface builder.
*   Customizable components and blocks.
*   HTML/CSS export, which can be used for PDF generation.
*   A plugin architecture, allowing for extensions.
*   Features like "Data Sources" which seem relevant for conditional logic and user-defined data.

## 3. High-Level Architecture

The visual template editor will be a new frontend module, likely a Single Page Application (SPA) or integrated within the existing SME platform's frontend. It will interact with the existing NestJS backend for saving, loading, and managing template definitions.

**Frontend (Visual Template Editor - GrapesJS based):**

*   Provides the UI for designing/customizing invoice templates.
*   Allows users to drag and drop predefined components (e.g., text blocks, image placeholders, tables for line items, special invoice fields) onto a canvas representing the invoice.
*   Allows users to define conditional display logic for components (e.g., show a section only if `invoice.total > 1000`).
*   Allows users to map template fields to data sources (standard invoice fields or custom user-defined data sources).
*   Saves the template definition (likely a JSON structure generated by GrapesJS) to the backend.
*   Previews the template with sample data or actual data.

**Backend (NestJS - Enhancements):**

*   **Template Entity (`InvoiceTemplate` in `invoice-template.entity.ts`):**
    *   `template_definition`: Change type to store the GrapesJS JSON definition (e.g., `JSONB` in PostgreSQL).
    *   `version`: Add an integer field for version number.
    *   `parent_template_id`: Add an optional field to link to a previous version if this is an updated template.
    *   `status`: Add a field for status (e.g., 'DRAFT', 'PUBLISHED', 'ARCHIVED').
    *   `is_default_system`: A flag to indicate if this is one of the system-provided default templates (which can be a base for customization but not directly edited).
*   **User-Defined Data Source Storage:**
    *   A new table/entity might be needed to store definitions for user-defined data sources if they are complex and reusable across templates. For simpler key-value pairs, they could potentially be stored as part of the template's JSON definition or a separate JSON field in the `InvoiceTemplate` entity.
*   **New/Updated API Endpoints:**
    *   **Template Management:**
        *   `POST /templates`: Create a new template (initial version).
        *   `PUT /templates/{id}`: Save changes to an existing template (creates a new version or updates draft).
        *   `GET /templates/{id}`: Retrieve a specific template definition.
        *   `GET /templates`: List available templates for the user/organization.
        *   `POST /templates/{id}/publish`: Mark a template as "PUBLISHED".
        *   `GET /templates/{id}/versions`: List all versions of a template.
        *   `POST /templates/{id}/revert/{version_id}`: Revert to a specific version (creates a new version based on the old one).
    *   **User-Defined Data (if stored centrally):**
        *   CRUD endpoints for managing these data source definitions.
*   **PDF Generation Service (`PdfGenerationService`):**
    *   **Input:** Will receive the GrapesJS JSON definition and the relevant invoice data (and any user-defined data).
    *   **Logic:**
        1.  Parse the GrapesJS JSON definition.
        2.  Dynamically construct the HTML based on the template structure and components defined in the JSON.
        3.  Inject the invoice data and user-defined data into the appropriate placeholders in the HTML.
        4.  Apply any conditional logic defined in the template (e.g., show/hide sections). This might require a simple expression engine or a predefined set of conditional operators.
        5.  Use Playwright/Puppeteer (as currently implemented) to convert the generated HTML to a PDF.
    *   **Consideration:** The complexity of this service will increase. It needs to be a robust HTML renderer that can accurately interpret the GrapesJS output. An alternative is to have GrapesJS directly output optimized HTML that the backend can use with minimal processing.

## 4. Key Features and Considerations for Phase 1.2+

*   **Visual Drag-and-Drop Editor:**
    *   **Core:** Based on GrapesJS.
    *   **Components:** Predefined components for common invoice elements (header, footer, item lines, totals, tax sections, etc.). Ability to add custom text, images.
    *   **Styling:** Font selection, colors, alignment, basic formatting.
*   **Conditional Display Logic:**
    *   Users should be able to define rules like "IF `total_amount` > 1000 THEN show `large_transaction_disclaimer`".
    *   The UI for defining these rules should be simple. The backend will need to interpret these rules when rendering the PDF.
*   **User-Defined Data Sources:**
    *   Beyond standard invoice fields (client name, invoice items, etc.), users might want to include other business-specific data.
    *   The system should allow defining these custom data fields (e.g., `project_manager_name`, `department_code`) and mapping them in the template.
    *   These could be simple key-value pairs initially.
*   **Template Versioning:**
    *   Each save of a template creates a new version.
    *   Ability to view version history and revert to a previous version.
    *   Potentially, a "draft" vs. "published" state for templates.
*   **Data Binding:**
    *   Clear mapping of template placeholders (e.g., `{{customer.name}}`) to data fields from the backend.
    *   The GrapesJS editor should facilitate adding these placeholders.
*   **Preview:**
    *   Real-time or near real-time preview of the invoice as it's being designed.
    *   Ability to preview with sample data.
*   **Output:**
    *   The editor saves the template structure (e.g., GrapesJS JSON).
    *   This structure is then used by the backend to generate the HTML that gets converted to PDF.

## 5. Workflow

1.  User accesses the "Invoice Template Editor" section.
2.  User can choose to create a new template (perhaps starting from a basic layout or an existing template) or edit an existing one.
3.  The GrapesJS editor loads with the template structure.
4.  User drags, drops, and configures components (text fields, data placeholders, images, tables).
    *   For data placeholders, they can select from a list of standard invoice fields or defined custom data fields.
    *   Conditional logic can be applied to sections.
5.  User previews the template with sample data.
6.  User saves the template. This triggers an API call to the backend.
7.  Backend saves the template definition (GrapesJS JSON) and updates its version.
8.  When an invoice needs to be generated:
    *   The backend retrieves the selected template's JSON definition.
    *   It fetches the relevant invoice data and any user-defined data.
    *   The `PdfGenerationService` processes the template JSON, applies data and conditional logic, and generates the HTML.
    *   The HTML is converted to PDF using Playwright/Puppeteer.

## 6. Impact on Existing System

*   **Database:** Schema changes for `InvoiceTemplate` entity as described. Potentially new tables for user-defined data sources and template versioning details if not incorporated into the main template entity.
*   **Backend API:** Significant new endpoints for managing templates, versions, and potentially user-defined data. Modification of existing PDF generation flow.
*   **Frontend:** A new, major UI module for the template editor.

## 7. Open Questions/Further Considerations

*   **Complexity of Conditional Logic:** How complex can the conditions be? Will simple IF-THEN suffice, or is a more powerful rule engine needed? Start simple.
*   **Performance of PDF Generation:** Dynamically building HTML from JSON and then rendering to PDF might be performance-intensive for very complex templates. This needs to be kept in mind, especially the part where the backend interprets the GrapesJS JSON. An alternative is to have GrapesJS directly output optimized HTML that the backend can use with minimal processing.
*   **Security of Custom Data:** If users can define custom data sources, ensure proper validation and sanitization if these are ever user-input driven, though for invoice templates, they are more likely predefined structures.
*   **Migration:** How will existing templates (if any) be migrated? (Assuming this is a new feature, so likely not an issue).
*   **Collaboration/Sharing:** Will templates be shareable between users/organizations in the future? (Out of scope for now).

This design document provides a foundation for the advanced template editor. The next step will be to refine the specifics of the GrapesJS integration and the backend API modifications.
